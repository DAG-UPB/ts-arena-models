name: ${COMPOSE_PROJECT_NAME}

services:
  master-controller-api:
    build: ./master-controller
    command: uvicorn api:app --host 0.0.0.0 --port 8000
    ports:
      - "8456:8000"
    environment:
      - DOCKER_HOST=http://docker-proxy:2375
      - TARGET_LABEL=managed.by=controller
      - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}
    env_file:
      - .env
    networks:
      - internal
    depends_on:
      - docker-proxy

  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    environment:
      - CONTAINERS=1
      - ALLOW_START=1
      - ALLOW_STOP=1
      - ALLOW_RESTARTS=1
      - IMAGES=0
      - NETWORKS=0
      - VOLUMES=0
      - POST=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - internal

  challenge-uploads:
    build: ./challenge-uploads
    environment:
      - API_BASE_URL=${API_BASE_URL:-http://api-portal:8000}
      - MASTER_CONTROLLER_URL=http://master-controller-api:8000
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT:-600}
      - API_UPLOAD_KEY=${API_UPLOAD_KEY}
      - USER_ID=${USER_ID}
      - CHECK_INTERVAL=${CHECK_INTERVAL:-60}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_DIR=/app/logs
      - LOG_RETENTION_DAYS=${LOG_RETENTION_DAYS:-3}
    volumes:
      - ./logs/challenge-uploads:/app/logs
    env_file:
      - .env
    networks:
      - internal
    depends_on:
      - master-controller-api
      - docker-proxy

include:
  - compose/chronos.yml
  - compose/timesfm.yml
  - compose/moirai.yml
  - compose/time-moe.yml
  - compose/moment.yml
  - compose/sundial.yml
  - compose/statistical.yml
  - compose/neuralforecast.yml
  - compose/tirex.yml
  - compose/visionts.yml
  - compose/flowstate.yml
  - compose/tinytimemixer.yml

volumes:
  arena-db:


networks:
  default:
  internal:
    driver: bridge
